<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dreamer.mapper.BoardMapper">

	<sql id="search">
		<if test='keyword != null and keyword != "".toString()'>
			<foreach collection="category" item="option" open="AND (" close=")" separator="OR">
				<if test='option == "T"'> title like concat('%',#{keyword},'%')</if>
				<if test='option == "C"'> content like concat('%',#{keyword},'%')</if>
				<if test='option == "W"'> writer like concat('%',#{keyword},'%')</if>
			</foreach>
		</if>
	</sql>

	<select id="selectAllBoard" resultType="com.dreamer.domain.BoardVO">
		select bt.*, ifnull(rt.rcount,0) as rcount, ifnull(att.atcount,0) as atcount 
		from tbl_board as bt left join (select boardno, count(rno) as rcount from tbl_reply group by boardno) as rt
		on rt.boardno = bt.bno
		left join (select boardno, count(ano) as atcount from tbl_attachment group by boardno) as att
		on att.boardno = bt.bno
		where bno > 0
		<include refid="search"></include>
		<if test='sort.sortBy == "bno"'> order by bt.bno</if>
		<if test='sort.sortBy == "title"'> order by bt.title</if>
		<if test='sort.sortBy == "views"'> order by bt.views</if>
		<if test='sort.sortBy == "date"'> order by bt.updateddate</if>
		<if test='sort.order == "ASC"'>asc</if>
		<if test='sort.order == "DESC"'>desc</if>
		limit #{pageRequest}, #{amount}
	</select>
	
	<select id="selectOneByBno" resultType="com.dreamer.domain.BoardVO">
		select bt.*, ifnull(rt.rcount,0) as rcount
		from tbl_board as bt
		left join (select boardno, count(rno) as rcount from tbl_reply
		group by boardno) as rt
		on rt.boardno = bt.bno
		where bno=#{bno}
	</select>

	<insert id="insertBoard">
		insert into tbl_board(writer, password, title, content)
		values(#{writer},#{password},#{title},#{content})
	</insert>
	
	<update id="increaseViews">
		update tbl_board set views = views+1 where bno = #{bno}
	</update>

	<select id="countAllBoards" resultType="int">
		select count(bno) from tbl_board 
		where bno > 0
		<include refid="search"></include>
	</select>

	<select id="authCheck" resultType="string">
		select password from tbl_board where bno = #{bno}
	</select>

	<update id="updateBoard">
		update tbl_board set title = #{title}, content = #{content} where bno = #{bno}
	</update>

	<delete id="deleteBoard">
		delete from tbl_board where bno = #{bno}
	</delete>
	
	<select id="getNextBoard" resultType="int">
		select bno from tbl_board where bno = (select min(bno) from tbl_board where bno > #{bno})
	</select>
	
	<select id="getPrevBoard" resultType="int">
	 <![CDATA[select bno from tbl_board where bno = (select max(bno) from tbl_board where bno < #{bno})]]>	
	</select>

</mapper>


